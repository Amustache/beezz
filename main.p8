pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
-- beeeeeees
-- by us

-- ** technical ** --
function delay(frames)
-- wait, in frames
-- 30 fps
 for x=1,frames do
  yield()
 end
end

function abs_box(o)
-- absolute box for object o
 local box = {}
 box.x1 = o.box.x1 + o.x
 box.y1 = o.box.y1 + o.y
 box.x2 = o.box.x2 + o.x
 box.y2 = o.box.y2 + o.y
 return box
end

function iou(o1,o2)
-- intersection over union of two objects
-- return percentage in [0,1], 1 is perfect match
 local box_o1 = abs_box(o1)
 local box_o2 = abs_box(o2)
 
 -- x,y coordinates of intersection
 local x1 = max(box_o1.x1,box_o2.x1)
 local y1 = max(box_o1.y1,box_o2.y1)
 local x2 = min(box_o1.x2,box_o2.x2)
 local y2 = min(box_o1.y2,box_o2.y2)
 
 -- area of intersection
 local inter_area = max(0, x2 - x1 + 1) * max(0, y2 - y1 + 1)
 
 -- area of both boxes
 local o1_area = (box_o1.x2 - box_o1.x1 + 1) * (box_o1.y2 - box_o1.y1 + 1)
 local o2_area = (box_o2.x2 - box_o2.x1 + 1) * (box_o2.y2 - box_o2.y1 + 1)

 return inter_area / (o1_area + o2_area - inter_area)
end

-- ** bee - general ** --
function init_bee_base()
 p={
  name="barry",
  tot_pln=0,  -- cumulative polen
  cur_pln=0,  -- current polen
  max_pln=50,  -- max usable polen before slowdown in speed
  spd=3,  -- speed
  x=64,  -- x,y coordinate
  y=64,
  box={x1=1,y1=1,x2=14,y2=14},  -- collision box
  sp=0,  -- current sprite
  view=5,  -- current direction cf. num_pad
  action=false  -- can't move if action is true
 }
end

function draw_bee()
 spr(p.sp,p.x,p.y,2,2)
end

-- ** actual game ** --
function _init()
 dt=0
 w=128 -- width of the game map
 h=128 -- height of the game map
 
 init_bee_base()
 -- todo
 exploration_init()
end

function _update()
 -- todo
 exploration_update()
end

function _draw()
 -- todo
 exploration_draw()
end
-->8
-- exploration
-- ** exploration - initialisation ** --
function exploration_init()
 -- flowers
 flowers={}
 for i=1,rnd(10) do
  add(flowers,{
   x=rnd(100)+10,
   y=rnd(100)+10,
   box={x1=2,y1=3,x2=12,y2=13},
   sp=32+2*flr(rnd(3)),
   pln=5
  })
 end
 
 tlrnc=0.25  -- percentage of match between bee and flower
end

-- ** exploration - updating ** --
function update_bee()
 if(not p.action) then
  if(btn(0)) then p.x-=p.spd end  -- left
  if(btn(1)) then p.x+=p.spd end  -- right
  if(btn(2)) then p.y-=p.spd end  -- up
  if(btn(3)) then p.y+=p.spd end  -- down
  -- action (X) -- todo talk w/ bees
  if btnp(5) then  
   get_pln()
  end
 end
end

function check_flower(f)
 if(iou(p,f) >= tlrnc) then
  p.cur_pln+=f.pln
  f.pln = 0
 end
end

function get_pln()
 -- todo add animation
 foreach(flowers,check_flower)
end

function exploration_update()
 -- delta time
 dt+=1
 
 update_bee()
end

-- ** exploration - drawing ** --
function draw_flower(f)
 spr(f.sp,f.x,f.y,2,2)
 if(f.pln > 0) then
  for i=1,f.pln do
   pset(f.x+i*.8+6,f.y+i*.7+8,9)
  end
 end
end

function testt(f)
 if(iou(p,f) >= tlrnc) then
  print("flower! "..iou(p,f),26,8,rnd(8))
 else
  print("bzz...",2,8,2)
 end
end

function exploration_draw()
 cls()
 print(dt.."/"..stat(7),2,2,3)
 print(btn(),2,14,3)
 foreach(flowers,draw_flower)
 foreach(flowers,testt)
 draw_bee() 
end
-->8
-- story


__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00009999999900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00009909909900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0ccccc99999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c0999c999ccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0ccaaa9c9cc999c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00cccaaaacaaa9c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0009ccaaaaaaacc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00099cc999cccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000999c99cc999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00009aaaac99aaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00009aaaaaaaaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000099999aaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00ccc000ccccc0000088800088888000002220002222200000000000000000000000000000000000000000000000000000000000000000000000000000000000
000ccc0ccccc00000008880888880000000222022222000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000ccc0ccc0000000008880888000000000222022200000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000ccccccc00000000088888880000000002222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000cc6ccccc0000000088688888000000002262222200000000000000000000000000000000000000000000000000000000000000000000000000000000000
00ccc66666ccc0000088866666888000002226666622200000000000000000000000000000000000000000000000000000000000000000000000000000000000
00cccc666c0000000088886668000000002222666200000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000c00c6cccc00000008008688880000000200262222000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000ccccccc00000000088888880000000002222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000cccc00c00000000088880080000000002222002000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000cc000000000000008800000000000000220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
